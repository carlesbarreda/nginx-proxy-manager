name: Nginx proxy manager images CI

on:
  workflow_dispatch:

jobs:
  Build:
    name: "Nginx proxy manager"
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      # https://github.com/docker/setup-buildx-action
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      # https://github.com/docker/buildx/issues/495#issuecomment-761562905
      - name: Adding custom builder
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --name multiarch --driver docker-container --use
          docker buildx inspect --bootstrap
      # https://github.com/docker/login-action
      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      # https://github.com/actions/starter-workflows/issues/68
      # https://github.com/firepress-org/rclone-in-docker/blob/master/.github/workflows/ci_dockerfile_is_master.yml
      - name: Get npm version
        run: echo "NPM_VERSION=$(cat .version)" >> $GITHUB_ENV
      - name: Build npm
        run: |
          cd scripts
          ./frontend-build
          ./buildx \
            --tag carlesbarreda/nginx-proxy-manager:$NPM_VERSION \
            --tag carlesbarreda/nginx-proxy-manager:latest \
            --progress=plain \
            --no-cache \
            --push
